name: Update Weather Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update-weather:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch weather data
      env:
        API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      run: |
        echo "Starting weather fetch for Mora, MN"
        curl -s "https://api.openweathermap.org/data/2.5/weather?q=Mora,MN,US&appid=$API_KEY&units=imperial" > weather_raw.json
        
        if [ -s weather_raw.json ]; then
          echo "Weather data received"
          echo '{"success":true,"data":' > weather-data.json
          cat weather_raw.json >> weather-data.json
          echo ',"cached":false,"timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","source":"GitHub Actions"}' >> weather-data.json
        else
          echo "Weather fetch failed"
          echo '{"success":false,"error":"API call failed","timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > weather-data.json
        fi
        
        rm -f weather_raw.json

    - name: Commit changes
      run: |
        git config user.email "actions@github.com"
        git config user.name "GitHub Actions"
        git add weather-data.json
        git diff --staged --quiet || (git commit -m "Update weather $(date)" && git push)
